<!-- equipment/templates/equipment/equipment_detail.html -->
{% extends "base_generic.html" %}

{% block title %}{{ equipment.name }} - Details{% endblock %}

{% block content %}
<h2>{{ equipment.name }} <small class="text-muted">({{ equipment.identifier }})</small></h2>

<div class="row">
    <div class="col-md-6">
        <p><strong>Category:</strong> {{ equipment.category.name|default:"N/A" }}</p>
        <p><strong>Status:</strong> <span class="badge bg-{% if equipment.status == equipment.STATUS_AVAILABLE %}success{% elif equipment.status == equipment.STATUS_BORROWED %}warning{% else %}danger{% endif %}">{{ equipment.get_status_display }}</span></p>
        <p><strong>Total Quantity:</strong> {{ equipment.quantity_total }}</p>
        <p><strong>Available Quantity:</strong> {{ equipment.quantity_available }}</p>
        <p><strong>Purchase Date:</strong> {{ equipment.purchase_date|date:"Y-m-d"|default:"N/A" }}</p>
        <p><strong>Description:</strong></p>
        <p>{{ equipment.description|linebreaksbr|default:"No description provided." }}</p>
    </div>
    <div class="col-md-6">
        {# Action Buttons #}
        {% comment %} {% if user.is_staff_member or user.is_superuser %} {% endcomment %}
        {% if user.is_teacher or user.is_staff_member_role or user.is_superuser %}
            <a href="{% url 'equipment:equipment_update' pk=equipment.pk %}" class="btn btn-secondary btn-sm">Edit Equipment</a>
            <a href="{% url 'equipment:equipment_delete' pk=equipment.pk %}" class="btn btn-danger btn-sm">Delete Equipment</a>
        {% endif %}
        {% if equipment.status == equipment.STATUS_AVAILABLE and equipment.quantity_available > 0 %}
            <a href="{% url 'equipment:borrow_equipment' equipment_id=equipment.id %}" class="btn btn-primary btn-sm mt-2">Borrow This Equipment</a>
        {% endif %}
        <a href="{% url 'equipment:create_repair_request' equipment_id=equipment.id %}" class="btn btn-warning btn-sm mt-2">Report Issue</a>
    </div>
</div>

<hr>

<h4>Borrowing History</h4>
{% if borrowing_history %}
    <table class="table table-hover table-sm">
        <thead>
            <tr>
                <th>Borrower</th>
                <th>Borrowed On</th>
                <th>Due Date</th>
                <th>Returned On</th>
                <th>Status</th>
                {% if user.is_staff or user.is_superuser %} {# “操作”列仅对职员显示 #}
                <th>Actions</th>
                {% endif %}
            </tr>
        </thead>
        <tbody>
            {% for record in borrowing_history %}
            <tr>
                <td>{{ record.borrower.get_full_name|default:record.borrower.username }}</td>
                <td>{{ record.borrow_date|date:"Y-m-d H:i" }}</td>
                <td>{{ record.due_date|date:"Y-m-d H:i" }}</td>
                <td>{{ record.return_date|date:"Y-m-d H:i"|default:"Not Returned" }}</td>
                <td>
                    {% if record.is_returned %}
                        <span class="badge bg-success">Returned</span>
                    {% elif record.is_overdue %}
                        <span class="badge bg-danger">Overdue</span>
                    {% else %}
                        <span class="badge bg-warning">Borrowed</span>
                    {% endif %}
                </td>
                {% if user.is_staff or user.is_superuser %}
                <td>
                    {% if not record.is_returned %}
                        {# 使用表单进行POST请求以更改状态 #}
                        <form method="POST" action="{% url 'equipment:return_equipment_record' record_id=record.pk %}" style="display: inline;">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-success btn-sm" title="Mark as Returned">
                                <i class="fas fa-undo-alt"></i> Return
                            </button>
                        </form>
                    {% endif %}
                </td>
                {% endif %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
{% else %}
    <p>No borrowing history for this equipment.</p>
{% endif %}

{# TODO: Repair Requests Section #}
<hr>
<h4>Repair Requests</h4>
{% if equipment.repair_requests.all %} {# 假设 RepairRequest 在 Equipment 模型上有 related_name='repair_requests' #}
    <ul id="repair-requests-list" class="list-group">
        {% for repair in equipment.repair_requests.all %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                <div>
                    Reported by {{ repair.reporter.username }} on {{ repair.reported_at|date:"Y-m-d" }}:
                    <small>{{ repair.description|truncatewords:10 }}</small>
                </div>
                <div>
                    <span class="badge bg-info rounded-pill me-2">{{ repair.get_status_display }}</span>
                    <a href="{% url 'equipment:repair_request_detail' pk=repair.pk %}" class="btn btn-outline-primary btn-sm">View</a>
                </div>
            </li>
        {% empty %}
            <li class="list-group-item">No repair requests for this equipment.</li>
        {% endfor %}
    </ul>
{% else %}
    <p>No repair requests for this equipment.</p>
{% endif %}

{% endblock %}