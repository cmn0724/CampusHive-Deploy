<!-- courses/templates/courses/course_detail.html -->
{% extends "base_generic.html" %}

{% block title %}{{ course.title }} - Details{% endblock %}

{% block content %}
<div class="course-detail-container">
    <h2>{{ course.course_code }} - {{ course.title }}</h2>
    <p><strong>Department:</strong> {{ course.department.name|default:"N/A" }}</p>
    <p><strong>Instructor:</strong> {{ course.instructor.get_full_name|default:course.instructor.username|default:"TBA" }}</p>
    <p><strong>Credits:</strong> {{ course.credits }}</p>
    <p><strong>Description:</strong></p>
    <p>{{ course.description|linebreaksbr }}</p>

    <hr>

    {% if user.is_authenticated %}
        {% if user.is_student %}
            {% if is_enrolled %}
                <p class="alert alert-success">You are enrolled in this course.</p>
                <form action="{% url 'courses:drop_course' enrollment_id=enrollment_id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-warning btn-sm">Drop Course</button>
                </form>
            {% else %}
                <form action="{% url 'courses:enroll_course' course_id=course.id %}" method="post" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-primary btn-sm">Enroll in this Course</button>
                </form>
            {% endif %}
        {% elif user.is_teacher and course.instructor == user %}
            <a href="{% url 'courses:course_update' pk=course.pk %}" class="btn btn-secondary btn-sm">Edit Course</a>
            <a href="{% url 'courses:course_delete' pk=course.pk %}" class="btn btn-danger btn-sm">Delete Course</a>
            {# TODO: Add links for managing materials and assignments #}
            <a href="{% url 'courses:upload_material' course_id=course.id %}" class="btn btn-info btn-sm">Upload Material</a>
            <a href="{% url 'courses:create_assignment' course_id=course.id %}" class="btn btn-info btn-sm">Create Assignment</a>
            <a href="{% url 'courses:grade_enrollments' course_id=course.id %}" class="btn btn-info btn-sm">Grade Students</a>

        {% endif %}
    {% endif %}

    {# Enrolled Students (for instructor) #}
    {% if enrolled_students %}
    <div class="mt-4">
        <h4>Enrolled Students:</h4>
        <ul>
            {% for student in enrolled_students %}
            <li>{{ student.get_full_name|default:student.username }}</li>
            {% empty %}
            <li>No students enrolled yet.</li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    {# Course Materials (TODO) #}
    <div class="mt-4">
        <h4>Course Materials:</h4>
        <ul id="course-materials-list">
            {% for material in course.materials.all %} {# Assuming related_name='materials' #}
                <li>
                    <a href="{{ material.file.url }}" target="_blank">{{ material.title }}</a>
                    ({{ material.file.name|cut:"course_materials/" }})
                    {% if user.is_teacher and course.instructor == user %}
                        <a href="{% url 'courses:delete_material' pk=material.id %}" class="text-danger btn-sm" onclick="return confirm('Are you sure you want to delete this material?');">Delete</a>
                    {% endif %}
                </li>
            {% empty %}
                <li>No materials uploaded yet.</li>
            {% endfor %}
        </ul>
    </div>

    {# Assignments (TODO) #}
    <div class="mt-4">
        <h4>Assignments:</h4>
        <ul id="assignments-list">
            {% for assignment in course.assignments.all %} {# Assuming related_name='assignments' #}
                <li>
                    <a href="{% url 'courses:assignment_detail' assignment_id=assignment.id %}">{{ assignment.title }}</a> - Due: {{ assignment.due_date|date:"Y-m-d H:i" }}
                    {% if user.is_teacher and course.instructor == user %}
                        {% comment %} <a href="{% url 'courses:update_assignment' assignment_id=assignment.id %}" class="btn btn-outline-secondary btn-sm">Edit</a> {% endcomment %}
                        <a href="{% url 'courses:update_assignment' pk=assignment.id %}" class="btn btn-outline-secondary btn-sm">Edit</a>
                        {% comment %} <a href="{% url 'courses:delete_assignment' assignment_id=assignment.id %}" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure?');">Delete</a> {% endcomment %}
                        <a href="{% url 'courses:delete_assignment' pk=assignment.id %}" class="btn btn-outline-danger">Delete</a>
                            {% comment %} {% if assignment.title == "Test Assignment 2" or assignment.title == "Test assignment 3" %}
                                {{ assignment.title }} {# 或者直接写 "Delete" #}
                            {% else %}
                                Delete {# 或者其他文本 #}
                            {% endif %} {% endcomment %}
                    {% endif %}
                </li>
            {% empty %}
                <li>No assignments posted yet.</li>
            {% endfor %}
        </ul>
    </div>
</div>
{% endblock %}